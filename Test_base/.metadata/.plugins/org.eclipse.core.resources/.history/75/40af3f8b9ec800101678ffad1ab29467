package com.healthcare.controller;
import org.modelmapper.ModelMapper;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.healthcare.dto.ApiResponse;
import com.healthcare.dto.CreatorSignUpDto;
import com.healthcare.dto.CreatorUpdateDto;
import com.healthcare.dto.videoPostDto;
import com.healthcare.entities.Creator;
import com.healthcare.entities.Post;
import com.healthcare.entities.PostType;
import com.healthcare.entities.User;
import com.healthcare.entities.UserType;
import com.healthcare.exception_handler.ResourceAlreadyExistsException;
import com.healthcare.service.CreatorService;
import com.healthcare.service.UserService;
import com.healthcare.service.YoutubeApiService;

import jakarta.validation.Valid;
import lombok.AllArgsConstructor;

@RestController
@RequestMapping("creators")
@AllArgsConstructor

public class CreatorController {
	
	// dependencies		

	private final UserService serviceImpl;
	private final CreatorService creatorService ;
	private final YoutubeApiService apiService;
//	private final CreatorValidation creatorValidation;
	private final ModelMapper modelMapper;
	
	
	@GetMapping("list")
	public ResponseEntity<?> listAll(){
		creatorService.findAll().forEach(s->System.out.println(s));
		return ResponseEntity.ok(creatorService.findAll());
	
	}
	

	@PostMapping("{id}/updateDetails")
	public ResponseEntity<?> updateCreator(@PathVariable Long id,@Valid @RequestBody CreatorUpdateDto dto)
	{		
		Creator f = creatorService.findById(id);
		User u = serviceImpl.findById(f.getUserId().getId());
		String str = "";
		
		if(dto.getEmail()!=null) {
			u.setEmail(dto.getEmail());
			str+=" email,";
		}
		if(dto.getFirstName()!=null) {
			u.setFirstName(dto.getFirstName());
			str+=" firstname,";
		}
		if(dto.getGender()!=null) {
			u.setGender(dto.getGender());
			str+=" gender,";
		}
		if(dto.getLastName()!=null) {
			u.setLastName(dto.getLastName());
			str+=" lastname,";
		}
		if(dto.getPassword()!=null) {
			u.setPassword(dto.getPassword());
			str+=" password,";
		}
		if(dto.getUsername()!=null) {
			u.setUsername(dto.getUsername());
			str+=" username,";
		}
		
		serviceImpl.updateUser(u);
		if(str.length()>0) {				
			return ResponseEntity.ok(new ApiResponse<String>("Updated "+str.substring(0, str.length()-1),true,"Update successfull"));
		}
		else {
			return ResponseEntity.ok(new ApiResponse<String>("No distint credentials were provided",false,"No update"));
		}
	}

	
	@PostMapping("/signUp")
	public ResponseEntity<?> newCreator(@Valid @RequestBody CreatorSignUpDto dto){
			
		// validate email
		if(serviceImpl.emailExist(dto.getEmail())) {
			throw new RuntimeException("Email id should be unique");				
		}
				
		// validate creator name
		if(!serviceImpl.ifExist(dto.getUsername())) {				
			User newUser = modelMapper.map(dto, User.class);
			newUser.setType(UserType.CREATOR);
			Creator newCreator = new Creator();
			newCreator.setUserId(newUser);
			creatorService.addCreator(newCreator);
			return ResponseEntity.status(HttpStatus.CREATED).body(new ApiResponse<String>("Welcome "+dto.getFirstName(),true,"SignUp successfull"));				
		}
		else {
			throw new ResourceAlreadyExistsException("Creator id should be unique");
		}
	}
	
	@PostMapping("/newPost")
	public ResponseEntity<?> createPost(@Valid @RequestBody videoPostDto vdto){
		System.out.println(vdto.getVideoUrl());
		Post p = modelMapper.map(vdto, Post.class);
		p.setPostType(PostType.VIDEO);
		
//			// validate title length
		int len = p.getPost_title().length();
		if(len >=30 && len <=60) {
			p.setVideoTag(apiService.verifyURL(vdto.getVideoUrl()))
			return ResponseEntity.ok();
		}
		throw new RuntimeException("Post title should be 30 to 60 characters long");

	}
}
