package com.healthcare.controller;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.web.csrf.CsrfToken;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.healthcare.dto.UserLoginDto;
import com.healthcare.entities.Creator;
import com.healthcare.entities.Foodie;
import com.healthcare.exception_handler.FoodieConflictException;
import com.healthcare.security.JwtUtils;
import com.healthcare.service.CreatorService;
import com.healthcare.service.FoodieService;
import com.healthcare.service.UserService;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import lombok.AllArgsConstructor;

@RestController
@RequestMapping("users")
@AllArgsConstructor

//  abhir@example.com | Abhishek   | male   | Rajvir    | abhi123

public class UserController /*~~(Could not parse as Java)~~>*/{
	
	// dependencies		

	//depcy 
	private final AuthenticationManager authenticationManager;
	private JwtUtils jwtUtils;
	
	private final UserService serviceImpl;
	private final CreatorService creatorService;
	private final FoodieService foodieService;
	
	
	@GetMapping("/csrf")
	public CsrfToken getCsrf(HttpServletRequest request ) {
		return (CsrfToken) request.getAttribute("s:_csrf");
	}
	
	@GetMapping("/greet")
	public String greet(HttpServletRequest request) {
		return "welcome user "+ request.getSession().getId();
	}
	
	@PostMapping("/signIn")
	public ResponseEntity<?> login(@Valid @RequestBody UserLoginDto dto){
		
				System.out.println("in user auth "+dto);
				//1 . Invoke the method of Spring Supplied AuthManager
				/* AuthenticationManager - i/f , Method
				 * public Authentication authenticate(Authentication auth) throws AuthenticationException
				 * Authentication - i/f
				 * Implemented by - UsernamePasswordAuthenticationToken(String email,String password)
				 * i/p - not yet verified (isAuth : false)
				 * o/p - Fully Authenticated UserDetails - email|username , password-null , Collection<GrantedAuthority> , isAuth : true
				 */
				UsernamePasswordAuthenticationToken authToken=new UsernamePasswordAuthenticationToken(dto.getEmail(), dto.getPassword());
				//2. To invoke the method on AuthMgr - first configure AuthMgr as bean(@Bean)
				// & then add it as the depcy
				System.out.println("before "+authToken.isAuthenticated());//false
				  Authentication fullyAuthenticated = authenticationManager.authenticate(authToken);
				  System.out.println(fullyAuthenticated.isAuthenticated());//true
				  System.out.println(fullyAuthenticated.getPrincipal().getClass());
				  //3. In case of success, create JWT send it to the REST Client (using JWT Utils - helper class)
					
					return ResponseEntity.status(HttpStatus.CREATED)
							.body(new AuthResp(jwtUtils.genrateToken(fullyAuthenticated),"Auth Success!"));
				
		
		return ResponseEntity.ok(serviceImpl.signIn(dto.getEmail(), dto.getPassword()));				
		
	}
	
	@Transactional
	@GetMapping("{foodie_id}/followCreator")
	public ResponseEntity<?> updateFoodie(@Valid @PathVariable Long foodie_id, @RequestParam Long creator_id){			
		// get persistant foodie by id
		Foodie f = foodieService.findByIdWithCreators(foodie_id);
		
		if(
			f.getCreators()
		    .stream()
		    .anyMatch(s -> s.getC_id()==(creator_id))	
			) {
			throw new FoodieConflictException("Foodie is already following creator: "+creator_id);
		}
		
		Creator c = creatorService.findByIdWithFoodies(creator_id);
		// insert creator to set or following list
		f.getCreators().add(c);
		
		// commit changes
		foodieService.updateFoodie(f);
		
		return ResponseEntity.ok("Foodie: "+foodie_id+" now follows Creator: "+creator_id);
		
	}
	
}
